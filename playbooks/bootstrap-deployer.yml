- hosts: all
  gather_facts: false
  become: true
  tasks:
    - name: Ensure deployer user
      user: { name: deployer, shell: /bin/bash, create_home: yes }

    - name: Add deployer to sudoers NOPASSWD
      copy:
        dest: /etc/sudoers.d/deployer
        content: "deployer ALL=(ALL) NOPASSWD:ALL\n"
        mode: '0440'

    - name: Authorize controller key (id_ed25519.pub) for deployer
      authorized_key:
        user: deployer
        state: present
        key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_ed25519.pub') }}"

    - name: Install base packages
      package:
        name: [python3, git, curl, tar, chrony]
        state: present

    - name: Enable chrony
      service: { name: chronyd, state: started, enabled: yes }
